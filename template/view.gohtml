<!DOCTYPE html>
<head>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <link rel='stylesheet' href='{{CreateURL "/static/index.css"}}'>
    <title>{{.Title}}</title>
</head>

<body>

<div id="app"></div>
<script src='{{CreateURL "/static/view.js"}}' data-params='{{Marshal .}}'>
</script>

<div class='fullscreen' style='padding-top:80px;'>
    <div class='carousel slide w-100 h-100' id='carouselControl'>
        <div class='carousel-inner w-100 h-100' id='carousel' style='width:100%; height:100%;'>
            {{range $i, $url := .ImageURLs}}
                <div class='carousel-item w-100 h-100 {{if eq $i 0}}active{{end}}'>
                    <div class='w-100 h-100 d-flex flex-col'>
                        <img class='ms-auto me-auto' loading='lazy' alt='page {{$i}}'
                             src='{{$url}}'
                             style='object-fit:contain;max-width:100%;max-height:100%'>
                    </div>
                </div>
            {{end}}
        </div>
        <a class='carousel-control-prev' data-bs-target='#carouselControl' role='button' data-bs-slide='prev'>
            <span class='carousel-control-prev-icon' aria-hidden='true'></span>
            <span class='visually-hidden'>Previous</span>
        </a>
        <a class='carousel-control-next' data-bs-target='#carouselControl' role='button' data-bs-slide='next'>
            <span class='carousel-control-next-icon' aria-hidden='true'></span>
            <span class='visually-hidden'>Next</span>
        </a>
    </div>
</div>

<div class='position-fixed bottom-0 end-0 p-3' style='z-index: 11'>
    <div id='toast' class='toast' role='alert' aria-live='assertive' aria-atomic='true'>
        <div class='toast-header'>
            <strong class='me-auto' id='toast-header'></strong>
            <button type='button' class='btn-close' data-bs-dismiss='toast' aria-label='Close'></button>
        </div>
        <div class='toast-body' id='toast-content'>
            Hello, world! This is a toast message.
        </div>
    </div>
</div>

<nav class='navbar navbar-dark bg-dark fixed-top navbar-expand-lg'>
    <div class='container-fluid'>
        <span class='navbar-brand mr-auto text-truncate h1 d-none d-sm-block' style='max-width: 50%;'>{{.Name}}</span>
        <span class='navbar-brand mr-auto text-truncate h1 d-block d-sm-none' style='max-width: 50%;'>View</span>

        <button class='navbar-toggler' type='button' data-bs-toggle='collapse'
                data-bs-target='#navbarSupportedContent' aria-controls='navbarSupportedContent'
                aria-expanded='false' aria-label='Toggle navigation'>

            <span class='navbar-toggler-icon'></span>
        </button>

        <div class='collapse navbar-collapse' id='navbarSupportedContent'>
            <ul class='navbar-nav mb-2 me-auto'>
                <li class='nav-item dropdown'>
                    <a class='nav-link dropdown-toggle' href='#' id='navbarDropdown'
                       role='button' data-bs-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>
                        <i class="bi bi-tags-fill"></i> Tags
                    </a>
                    <div class='dropdown-menu' aria-labelledby='navbarDropdown'>
                        {{range .Tags}}
                            <a class='dropdown-item' href='{{CreateBrowseTagURL .}}'>
                                <i class="bi bi-tag"></i>
                                {{.}}
                            </a>
                        {{end}}
                    </div>
                </li>
                <li class='nav-item dropdown'>
                    <a class='nav-link dropdown-toggle' href='#' id='navbarDropdown'
                       role='button' data-bs-toggle='dropdown' aria-haspopup='true' aria-expanded='false'>
                        <i class='bi bi-list'></i> Menu
                    </a>
                    <div class='dropdown-menu' aria-labelledby='navbarDropdown'>
                        <a class='dropdown-item' id='download-btn' download>
                            <i class='bi bi-download'></i>
                            Download Current Page
                        </a>
                        <a class='dropdown-item' download href='{{CreateDownloadURL .Name}}'>
                            <i class='bi bi-download'></i>
                            Download Manga
                        </a>
                        <div class='dropdown-divider'></div>
                        <a class='dropdown-item' id='update-cover-btn' onclick='updateCover(0); return false;'>
                            <i class='bi bi-journal-arrow-up'></i>
                            Update Cover
                        </a>
                    </div>
                </li>
            </ul>
            <ul class='navbar-nav'>
                <li class='nav-item mb-2 mb-lg-0 ms-lg-2'>
                    <a id='favorite-btn' class='btn {{if .Favorite}}btn-pink active{{else}} btn-outline-pink{{end}}'
                       onclick='toggleFavorite(); return false;'>
                        <i class='bi bi-star-fill'></i> Favorite
                    </a>
                </li>
                <li class='nav-item mb-2 mb-lg-0 ms-lg-2'>
                    <a id='close-btn' class='btn btn-danger' href='{{.BrowseURL}}'>
                        <i class='bi bi-x-circle-fill'></i> Close
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>
<script src='{{CreateURL "/static/index.js"}}'></script>
<script>
    let favorite = {{.Favorite}};

    $(function () {
        if (window.location.search !== '')
            window.location.search = ''

        $('.carousel').carousel({
            interval: false
        })

        let downloadUrls = [{{range .DownloadPageURLs}}
            '{{.}}',
            {{end}}]

        $('#carouselControl').on('slide.bs.carousel', function (e) {
            $('#download-btn').attr('href', downloadUrls[e.to])
            $('#update-cover-btn').attr('onclick', `updateCover(${e.to}); return false;`)
        })

        $('#download-btn').attr('href', downloadUrls[0])
        $('#update-cover-btn').attr('onclick', 'updateCover(0); return false;')
    });

    function updateFavoriteButton(favorite) {
        const btn = $('#favorite-btn')
        if (favorite) {
            btn.removeClass()
            btn.addClass('btn btn-pink active')
        } else {
            btn.removeClass()
            btn.addClass('btn btn-outline-pink')
        }
    }

    function toggleFavorite() {
        const params = new URLSearchParams()
        params.set('favorite', (!favorite).toString())

        const url = new URL({{ CreateSetFavoriteURL .Name}}, window.location.origin)
        url.search = params.toString()

        $.ajax({
            url: url.toString(),
            dataType: 'json',
        }).done(function (data) {
            favorite = data.favorite
            updateFavoriteButton(favorite);
            if (favorite) {
                showToast('Favorite', 'The current manga is now your favorite.')
            } else {
                showToast('Favorite', 'The current manga is no longer your favorite.')
            }
        })
    }

    function updateCover(index) {
        const updateCoverUrls = [{{range .UpdateCoverURLs}}
            '{{.}}',
            {{end}}]

        const url = updateCoverUrls[index]

        $.ajax({
            url: url.toString(),
            dataType: 'json',
        }).done(function () {
            showToast('Update Cover', 'The cover image is updated successfully.')
        })
    }

    function showToast(header, content) {
        $('#toast-header').text(header);
        $('#toast-content').text(content);

        let toast = new bootstrap.Toast($('#toast'));

        toast.show()
    }

</script>
</body>
